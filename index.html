<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Gastos 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-10">

    <div class="max-w-4xl mx-auto px-4 py-8">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ðŸ“Š Finanzas 2026</h1>
                <p class="text-slate-500 text-sm">Control mensual de gastos e ingresos</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openReportModal()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-3 py-1.5 rounded-lg text-sm hover:from-purple-700 hover:to-indigo-700 transition flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-chart-pie"></i> Reporte Mensual
                </button>
                <button onclick="openBackupModal()" class="bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-lg text-sm hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-cloud"></i> Backup
                </button>
            </div>
        </div>

        <!-- Resumen Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 shadow-sm">
                <span class="text-emerald-600 font-semibold text-xs uppercase tracking-wide">Ingresos</span>
                <span class="text-xl font-bold text-emerald-700 block mt-1" id="total-income">$0.00</span>
            </div>
            <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100 shadow-sm">
                <span class="text-rose-600 font-semibold text-xs uppercase tracking-wide">Gastos Pagados</span>
                <span class="text-xl font-bold text-rose-700 block mt-1" id="total-paid">$0.00</span>
            </div>
            <div class="bg-amber-50 p-4 rounded-2xl border border-amber-100 shadow-sm">
                <span class="text-amber-600 font-semibold text-xs uppercase tracking-wide">Por Pagar</span>
                <span class="text-xl font-bold text-amber-700 block mt-1" id="total-pending">$0.00</span>
            </div>
            <div class="bg-indigo-600 p-4 rounded-2xl shadow-lg text-white relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-2 -translate-y-2">
                    <i class="fa-solid fa-wallet text-5xl"></i>
                </div>
                <span class="text-indigo-200 font-semibold text-xs uppercase tracking-wide">Saldo</span>
                <span class="text-xl font-bold block mt-1" id="balance">$0.00</span>
            </div>
        </div>

        <!-- Barra de Progreso de Gastos -->
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-6">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-slate-600">Progreso de Pagos del Mes</span>
                <span class="text-sm text-slate-500" id="progress-text">0 de 0 pagados</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-3">
                <div class="bg-gradient-to-r from-indigo-500 to-emerald-500 h-3 rounded-full transition-all duration-500" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Formulario para Agregar -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6">
            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-plus-circle text-indigo-500"></i> Agregar Nuevo
            </h3>
            <form id="form" class="space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo</label>
                        <select id="type" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer" onchange="updateCategoryOptions()">
                            <option value="gasto">ðŸ“‹ Gasto Planificado</option>
                            <option value="ingreso">ðŸ’° Ingreso</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Monto</label>
                        <input type="number" id="amount" placeholder="0.00" step="0.01" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fecha</label>
                        <input type="date" id="date" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">CategorÃ­a</label>
                        <select id="category" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">DescripciÃ³n</label>
                        <input type="text" id="text" placeholder="Ej: Luz de enero, Netflix, etc." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 rounded-xl transition shadow-md hover:shadow-lg active:scale-[0.99] self-end">
                        <i class="fa-solid fa-plus"></i> Agregar
                    </button>
                </div>
            </form>
        </div>

        <!-- Tabs de NavegaciÃ³n -->
        <div class="flex border-b border-slate-200 mb-4">
            <button onclick="switchTab('pending')" id="tab-pending" class="px-4 py-2 font-semibold text-sm tab-active transition">
                <i class="fa-solid fa-clock"></i> Pendientes <span id="pending-count" class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs ml-1">0</span>
            </button>
            <button onclick="switchTab('paid')" id="tab-paid" class="px-4 py-2 font-semibold text-sm text-slate-500 hover:text-slate-700 transition">
                <i class="fa-solid fa-check-circle"></i> Pagados <span id="paid-count" class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs ml-1">0</span>
            </button>
            <button onclick="switchTab('income')" id="tab-income" class="px-4 py-2 font-semibold text-sm text-slate-500 hover:text-slate-700 transition">
                <i class="fa-solid fa-coins"></i> Ingresos <span id="income-count" class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full text-xs ml-1">0</span>
            </button>
        </div>

        <!-- Lista de Items -->
        <div id="list-container">
            <ul id="list" class="space-y-3"></ul>
            <div id="empty-state" class="text-center py-10 text-slate-400 hidden">
                <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                <p>No hay items en esta secciÃ³n</p>
            </div>
        </div>

        <!-- BotÃ³n Limpiar -->
        <div class="mt-6 text-center">
            <button onclick="confirmClear()" class="text-xs text-rose-400 hover:text-rose-600 hover:underline">
                <i class="fa-solid fa-trash"></i> Limpiar Todo el Historial
            </button>
        </div>
    </div>

    <!-- Modal de Backup -->
    <div id="backup-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4" onclick="if(event.target === this) closeBackupModal()">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800"><i class="fa-solid fa-cloud text-indigo-500"></i> Backup de Datos</h3>
                <button onclick="closeBackupModal()" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
            </div>
            
            <div class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                <!-- Exportar -->
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                    <h4 class="font-semibold text-emerald-700 mb-3"><i class="fa-solid fa-download"></i> Guardar Backup</h4>
                    <div class="flex flex-col gap-2">
                        <button onclick="exportAsFile()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-arrow-down"></i> Descargar archivo .txt
                        </button>
                        <button onclick="copyToClipboard()" class="w-full bg-white border border-emerald-300 text-emerald-700 py-2 px-4 rounded-lg transition hover:bg-emerald-50 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-copy"></i> Copiar al portapapeles
                        </button>
                    </div>
                </div>

                <!-- Importar -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="font-semibold text-blue-700 mb-3"><i class="fa-solid fa-upload"></i> Cargar Backup</h4>
                    <div class="flex flex-col gap-2">
                        <label class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-file-arrow-up"></i> Cargar desde archivo
                            <input type="file" id="importFile" class="hidden" accept=".txt,.json,text/plain,application/json" onchange="importFromFile(this)">
                        </label>
                        <button onclick="showPasteArea()" class="w-full bg-white border border-blue-300 text-blue-700 py-2 px-4 rounded-lg transition hover:bg-blue-50 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-paste"></i> Pegar desde portapapeles
                        </button>
                    </div>
                    
                    <!-- Ãrea de pegar -->
                    <div id="paste-area" class="hidden mt-3">
                        <textarea id="paste-input" rows="4" class="w-full bg-white border border-blue-200 rounded-lg p-3 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Pega aquÃ­ los datos del backup..."></textarea>
                        <button onclick="importFromPaste()" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition">
                            <i class="fa-solid fa-check"></i> Cargar datos pegados
                        </button>
                    </div>
                </div>

                <!-- Info -->
                <p class="text-xs text-slate-400 text-center">
                    <i class="fa-solid fa-info-circle"></i> En mÃ³vil: usa "Copiar" y "Pegar" para transferir datos entre dispositivos
                </p>
            </div>
        </div>
    </div>

    <!-- Modal de Reporte Mensual -->
    <div id="report-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4" onclick="if(event.target === this) closeReportModal()">
        <div class="bg-white rounded-2xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-gradient-to-r from-purple-600 to-indigo-600">
                <h3 class="font-bold text-lg text-white"><i class="fa-solid fa-chart-pie"></i> Reporte Mensual</h3>
                <button onclick="closeReportModal()" class="text-white/80 hover:text-white text-xl">&times;</button>
            </div>
            
            <div class="p-4 space-y-6 max-h-[75vh] overflow-y-auto">
                <!-- Selector de Mes -->
                <div class="flex flex-wrap gap-4 items-center justify-between bg-slate-50 p-3 rounded-xl">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-semibold text-slate-600">Mes:</label>
                        <input type="month" id="report-month" class="bg-white border border-slate-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="generateReport()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded-lg text-sm transition flex items-center gap-2">
                            <i class="fa-solid fa-sync"></i> Generar
                        </button>
                        <button onclick="downloadReportPDF()" id="btn-download-pdf" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-1.5 rounded-lg text-sm transition flex items-center gap-2">
                            <i class="fa-solid fa-file-pdf"></i> Descargar PDF
                        </button>
                    </div>
                </div>

                <!-- Resumen del Mes -->
                <div id="report-summary" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 text-center">
                        <span class="text-emerald-600 font-semibold text-xs uppercase">Ingresos</span>
                        <span class="text-lg font-bold text-emerald-700 block" id="report-income">$0.00</span>
                    </div>
                    <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 text-center">
                        <span class="text-rose-600 font-semibold text-xs uppercase">Gastos</span>
                        <span class="text-lg font-bold text-rose-700 block" id="report-expenses">$0.00</span>
                    </div>
                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 text-center">
                        <span class="text-amber-600 font-semibold text-xs uppercase">Pendientes</span>
                        <span class="text-lg font-bold text-amber-700 block" id="report-pending">$0.00</span>
                    </div>
                    <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center">
                        <span class="text-indigo-600 font-semibold text-xs uppercase">Balance</span>
                        <span class="text-lg font-bold text-indigo-700 block" id="report-balance">$0.00</span>
                    </div>
                </div>

                <!-- GrÃ¡fico Circular -->
                <div class="bg-white border border-slate-200 rounded-xl p-4">
                    <h4 class="font-semibold text-slate-700 mb-4 text-center"><i class="fa-solid fa-chart-pie text-indigo-500"></i> DistribuciÃ³n de Gastos</h4>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-6">
                        <canvas id="pie-chart" width="220" height="220"></canvas>
                        <div id="chart-legend" class="text-sm space-y-1 max-h-48 overflow-y-auto"></div>
                    </div>
                    <p id="no-expenses-msg" class="text-center text-slate-400 py-8 hidden">
                        <i class="fa-solid fa-chart-pie text-4xl mb-2 block"></i>
                        No hay gastos en este perÃ­odo
                    </p>
                </div>

                <!-- Desglose por CategorÃ­as -->
                <div class="bg-white border border-slate-200 rounded-xl p-4">
                    <h4 class="font-semibold text-slate-700 mb-4"><i class="fa-solid fa-list text-indigo-500"></i> Gastos por CategorÃ­a</h4>
                    <div id="category-breakdown" class="space-y-2"></div>
                    <p id="no-categories-msg" class="text-center text-slate-400 py-4 hidden">
                        No hay gastos para mostrar
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de CategorÃ­a -->
    <div id="detail-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] hidden p-4" onclick="if(event.target === this) closeDetailModal()">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" id="detail-title"><i class="fa-solid fa-list"></i> Detalle</h3>
                <button onclick="closeDetailModal()" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto">
                <ul id="detail-list" class="space-y-2"></ul>
            </div>
        </div>
    </div>

    <script>
        // --- Referencias DOM ---
        const totalIncomeEl = document.getElementById('total-income');
        const totalPaidEl = document.getElementById('total-paid');
        const totalPendingEl = document.getElementById('total-pending');
        const balanceEl = document.getElementById('balance');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const list = document.getElementById('list');
        const emptyState = document.getElementById('empty-state');
        const form = document.getElementById('form');
        const typeInput = document.getElementById('type');
        const textInput = document.getElementById('text');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const categoryInput = document.getElementById('category');

        // --- CategorÃ­as Expandidas ---
        const categories = {
            // Ingresos
            ingreso: {
                salario: { label: 'ðŸ’° Salario', color: 'text-emerald-600', bg: 'bg-emerald-100', icon: 'fa-money-bill-wave' },
                freelance: { label: 'ðŸ’¼ Freelance', color: 'text-emerald-600', bg: 'bg-emerald-100', icon: 'fa-laptop' },
                otros_ingresos: { label: 'ðŸ“¥ Otros Ingresos', color: 'text-emerald-600', bg: 'bg-emerald-100', icon: 'fa-hand-holding-dollar' }
            },
            // Gastos
            gastos: {
                // Servicios
                luz: { label: 'ðŸ’¡ Luz', color: 'text-yellow-600', bg: 'bg-yellow-100', icon: 'fa-lightbulb' },
                gas: { label: 'ðŸ”¥ Gas', color: 'text-orange-600', bg: 'bg-orange-100', icon: 'fa-fire' },
                agua: { label: 'ðŸ’§ Agua', color: 'text-cyan-600', bg: 'bg-cyan-100', icon: 'fa-droplet' },
                internet: { label: 'ðŸŒ Internet', color: 'text-blue-600', bg: 'bg-blue-100', icon: 'fa-wifi' },
                celular: { label: 'ðŸ“± Celular', color: 'text-violet-600', bg: 'bg-violet-100', icon: 'fa-mobile-screen' },
                netflix: { label: 'ðŸŽ¬ Netflix', color: 'text-red-600', bg: 'bg-red-100', icon: 'fa-tv' },
                hbo: { label: 'ðŸ“º HBO', color: 'text-purple-600', bg: 'bg-purple-100', icon: 'fa-film' },
                disney: { label: 'âœ¨ Disney+', color: 'text-blue-600', bg: 'bg-blue-100', icon: 'fa-wand-magic-sparkles' },
                spotify: { label: 'ðŸŽµ Spotify', color: 'text-green-600', bg: 'bg-green-100', icon: 'fa-music' },
                google: { label: 'ðŸ” Google', color: 'text-blue-600', bg: 'bg-blue-100', icon: 'fa-google' },
                // Casa
                alquiler: { label: 'ðŸ  Alquiler/Hipoteca', color: 'text-slate-600', bg: 'bg-slate-100', icon: 'fa-house' },
                mantenimiento: { label: 'ðŸ”§ Mantenimiento', color: 'text-slate-600', bg: 'bg-slate-100', icon: 'fa-wrench' },
                electrodomesticos: { label: 'ðŸ”Œ ElectrodomÃ©sticos', color: 'text-gray-600', bg: 'bg-gray-100', icon: 'fa-plug' },
                muebles: { label: 'ðŸ›‹ï¸ Muebles', color: 'text-amber-700', bg: 'bg-amber-100', icon: 'fa-couch' },
                // Comida
                supermercado: { label: 'ðŸ›’ Supermercado', color: 'text-emerald-600', bg: 'bg-emerald-100', icon: 'fa-cart-shopping' },
                comida: { label: 'ðŸ” Comida/Delivery', color: 'text-orange-600', bg: 'bg-orange-100', icon: 'fa-utensils' },
                // Transporte
                transporte: { label: 'ðŸšŒ Transporte', color: 'text-blue-600', bg: 'bg-blue-100', icon: 'fa-bus' },
                gasolina: { label: 'â›½ Gasolina', color: 'text-amber-600', bg: 'bg-amber-100', icon: 'fa-gas-pump' },
                // Salud
                salud: { label: 'ðŸ’Š Salud', color: 'text-teal-600', bg: 'bg-teal-100', icon: 'fa-heart-pulse' },
                gimnasio: { label: 'ðŸ‹ï¸ Gimnasio', color: 'text-indigo-600', bg: 'bg-indigo-100', icon: 'fa-dumbbell' },
                seguros: { label: 'ðŸ›¡ï¸ Seguros', color: 'text-sky-600', bg: 'bg-sky-100', icon: 'fa-shield-halved' },
                // Familia
                familia: { label: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Familia', color: 'text-pink-600', bg: 'bg-pink-100', icon: 'fa-people-roof' },
                ninos: { label: 'ðŸ‘¶ NiÃ±os', color: 'text-pink-600', bg: 'bg-pink-100', icon: 'fa-baby' },
                escuela: { label: 'ðŸŽ“ Escuela', color: 'text-indigo-600', bg: 'bg-indigo-100', icon: 'fa-graduation-cap' },
                mascota: { label: 'ðŸ¾ Mascota', color: 'text-orange-600', bg: 'bg-orange-100', icon: 'fa-paw' },
                // Entretenimiento
                salidas: { label: 'ðŸ» Salidas', color: 'text-amber-600', bg: 'bg-amber-100', icon: 'fa-champagne-glasses' },
                cine: { label: 'ðŸŽ¬ Cine', color: 'text-rose-600', bg: 'bg-rose-100', icon: 'fa-clapperboard' },
                regalos: { label: 'ðŸŽ Regalos', color: 'text-pink-600', bg: 'bg-pink-100', icon: 'fa-gift' },
                ocio: { label: 'ðŸŽ‰ Ocio', color: 'text-fuchsia-600', bg: 'bg-fuchsia-100', icon: 'fa-face-laugh' },
                vacaciones: { label: 'ðŸ–ï¸ Vacaciones', color: 'text-cyan-600', bg: 'bg-cyan-100', icon: 'fa-umbrella-beach' },
                // TecnologÃ­a
                tecnologia: { label: 'ðŸ’» TecnologÃ­a', color: 'text-slate-600', bg: 'bg-slate-100', icon: 'fa-laptop' },
                // Finanzas
                prestamos: { label: 'ðŸ¦ PrÃ©stamos', color: 'text-red-600', bg: 'bg-red-100', icon: 'fa-landmark' },
                creditos: { label: 'ðŸ’³ CrÃ©ditos', color: 'text-red-600', bg: 'bg-red-100', icon: 'fa-credit-card' },
                // Profesionales
                abogado: { label: 'âš–ï¸ Abogado', color: 'text-gray-700', bg: 'bg-gray-100', icon: 'fa-scale-balanced' },
                // Otros
                ropa: { label: 'ðŸ‘• Ropa', color: 'text-purple-600', bg: 'bg-purple-100', icon: 'fa-shirt' },
                educacion: { label: 'ðŸ“š EducaciÃ³n', color: 'text-blue-600', bg: 'bg-blue-100', icon: 'fa-book' },
                otros: { label: 'ðŸ“¦ Otros', color: 'text-slate-600', bg: 'bg-slate-100', icon: 'fa-box' }
            }
        };

        // --- Estado ---
        const STORAGE_KEY = 'gastos_app_2026_v2';
        let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let currentTab = 'pending';

        // Fecha de hoy por defecto
        dateInput.valueAsDate = new Date();

        // --- Formateo de Moneda ---
        function formatCurrency(amount) {
            return amount.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- Funciones de CategorÃ­as ---
        function updateCategoryOptions() {
            const type = typeInput.value;
            categoryInput.innerHTML = '';
            
            const cats = type === 'ingreso' ? categories.ingreso : categories.gastos;
            
            for (const [key, val] of Object.entries(cats)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = val.label;
                categoryInput.appendChild(option);
            }
        }

        function getCategoryStyle(category) {
            return categories.ingreso[category] || categories.gastos[category] || categories.gastos.otros;
        }

        // --- Funciones CRUD ---
        function addItem(e) {
            e.preventDefault();
            
            if (!textInput.value.trim() || !amountInput.value) {
                return alert('Por favor completa todos los campos');
            }

            const item = {
                id: Date.now(),
                text: textInput.value.trim(),
                amount: parseFloat(amountInput.value),
                date: dateInput.value,
                category: categoryInput.value,
                type: typeInput.value,
                paid: typeInput.value === 'ingreso' // Ingresos se marcan como "procesados" automÃ¡ticamente
            };

            items.push(item);
            saveAndRender();
            
            // Reset form
            textInput.value = '';
            amountInput.value = '';
        }

        function deleteItem(id) {
            if (confirm('Â¿Eliminar este item?')) {
                items = items.filter(item => item.id !== id);
                saveAndRender();
            }
        }

        function togglePaid(id) {
            const item = items.find(i => i.id === id);
            if (item && item.type === 'gasto') {
                item.paid = !item.paid;
                if (item.paid) {
                    item.paidDate = new Date().toISOString().slice(0, 10);
                } else {
                    delete item.paidDate;
                }
                saveAndRender();
            }
        }

        // --- Renderizado ---
        function renderList() {
            list.innerHTML = '';
            
            let filteredItems = [];
            
            if (currentTab === 'pending') {
                filteredItems = items.filter(i => i.type === 'gasto' && !i.paid);
            } else if (currentTab === 'paid') {
                filteredItems = items.filter(i => i.type === 'gasto' && i.paid);
            } else if (currentTab === 'income') {
                filteredItems = items.filter(i => i.type === 'ingreso');
            }

            // Ordenar por fecha
            filteredItems.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (filteredItems.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');

            filteredItems.forEach(item => {
                const li = document.createElement('li');
                const style = getCategoryStyle(item.category);
                
                li.className = 'fade-in bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center group';
                
                const isExpense = item.type === 'gasto';
                const amountColor = isExpense ? 'text-rose-600' : 'text-emerald-600';
                const amountSign = isExpense ? '-' : '+';

                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full ${style.bg} flex items-center justify-center ${style.color} text-lg shrink-0">
                            <i class="fa-solid ${style.icon}"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-800">${item.text}</p>
                            <p class="text-xs text-slate-400 font-medium">
                                ${item.date} &bull; <span class="capitalize">${style.label.replace(/^[^\s]+\s/, '')}</span>
                                ${item.paidDate ? `&bull; <span class="text-emerald-500">Pagado ${item.paidDate}</span>` : ''}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <p class="font-bold ${amountColor} text-lg">
                            ${amountSign}$${formatCurrency(item.amount)}
                        </p>
                        <div class="flex gap-1">
                            ${isExpense ? `
                                <button onclick="togglePaid(${item.id})" class="p-2 rounded-lg ${item.paid ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400 hover:bg-emerald-100 hover:text-emerald-600'} transition" title="${item.paid ? 'Marcar como pendiente' : 'Marcar como pagado'}">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteItem(${item.id})" class="p-2 rounded-lg bg-slate-100 text-slate-400 hover:bg-rose-100 hover:text-rose-600 transition opacity-0 group-hover:opacity-100" title="Eliminar">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                list.appendChild(li);
            });
        }

        function updateTotals() {
            const incomeItems = items.filter(i => i.type === 'ingreso');
            const paidItems = items.filter(i => i.type === 'gasto' && i.paid);
            const pendingItems = items.filter(i => i.type === 'gasto' && !i.paid);

            const totalIncome = incomeItems.reduce((acc, i) => acc + i.amount, 0);
            const totalPaid = paidItems.reduce((acc, i) => acc + i.amount, 0);
            const totalPending = pendingItems.reduce((acc, i) => acc + i.amount, 0);
            const balance = totalIncome - totalPaid;

            totalIncomeEl.textContent = `$${formatCurrency(totalIncome)}`;
            totalPaidEl.textContent = `$${formatCurrency(totalPaid)}`;
            totalPendingEl.textContent = `$${formatCurrency(totalPending)}`;
            balanceEl.textContent = `$${formatCurrency(balance)}`;

            // Actualizar contadores de tabs
            document.getElementById('pending-count').textContent = pendingItems.length;
            document.getElementById('paid-count').textContent = paidItems.length;
            document.getElementById('income-count').textContent = incomeItems.length;

            // Barra de progreso
            const totalExpenses = paidItems.length + pendingItems.length;
            const progress = totalExpenses > 0 ? (paidItems.length / totalExpenses) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${paidItems.length} de ${totalExpenses} pagados`;
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Actualizar estilos de tabs
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('text-slate-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-slate-500');
            
            renderList();
        }

        function saveAndRender() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
            renderList();
            updateTotals();
        }

        function confirmClear() {
            if (confirm('Â¿Borrar TODO el historial? Esta acciÃ³n no se puede deshacer.')) {
                items = [];
                saveAndRender();
            }
        }

        // --- Backup Modal ---
        function openBackupModal() {
            document.getElementById('backup-modal').classList.remove('hidden');
            document.getElementById('paste-area').classList.add('hidden');
        }

        function closeBackupModal() {
            document.getElementById('backup-modal').classList.add('hidden');
        }

        function showPasteArea() {
            document.getElementById('paste-area').classList.remove('hidden');
            document.getElementById('paste-input').value = '';
            document.getElementById('paste-input').focus();
        }

        // --- Backup/Restore ---
        function getBackupData() {
            return JSON.stringify(items);
        }

        function exportAsFile() {
            if (items.length === 0) return alert('No hay datos para exportar');
            
            const data = getBackupData();
            const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.download = `backup_gastos_${new Date().toISOString().slice(0, 10)}.txt`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('âœ… Archivo descargado. BÃºscalo en tu carpeta de Descargas.');
        }

        async function copyToClipboard() {
            if (items.length === 0) return alert('No hay datos para copiar');
            
            try {
                await navigator.clipboard.writeText(getBackupData());
                alert('âœ… Datos copiados al portapapeles.\n\nAhora puedes pegarlos en otro dispositivo.');
            } catch (err) {
                // Fallback para navegadores sin soporte
                const textarea = document.createElement('textarea');
                textarea.value = getBackupData();
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('âœ… Datos copiados al portapapeles.');
            }
        }

        function importFromFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                processImportData(e.target.result);
            };
            reader.readAsText(file);
            input.value = '';
        }

        function importFromPaste() {
            const pasteInput = document.getElementById('paste-input');
            const data = pasteInput.value.trim();
            
            if (!data) return alert('Por favor pega los datos primero');
            
            processImportData(data);
        }

        function processImportData(rawData) {
            try {
                const data = JSON.parse(rawData);
                if (Array.isArray(data)) {
                    if (confirm(`Se cargarÃ¡n ${data.length} items. Â¿Reemplazar datos actuales?`)) {
                        items = data;
                        saveAndRender();
                        closeBackupModal();
                        alert('âœ… Datos cargados correctamente');
                    }
                } else {
                    alert('âŒ Formato de datos incorrecto');
                }
            } catch (err) {
                alert('âŒ Error al leer los datos. Verifica que el formato sea correcto.');
            }
        }

        // --- Report Modal ---
        const chartColors = [
            '#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9', 
            '#6366f1', '#8b5cf6', '#d946ef', '#ec4899', '#f43f5e', '#64748b',
            '#84cc16', '#06b6d4', '#a855f7', '#f59e0b', '#10b981', '#3b82f6'
        ];

        let currentReportData = { month: '', categoryData: {} };

        function openReportModal() {
            document.getElementById('report-modal').classList.remove('hidden');
            const now = new Date();
            document.getElementById('report-month').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            generateReport();
        }

        function closeReportModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        function generateReport() {
            const monthInput = document.getElementById('report-month').value;
            if (!monthInput) return;

            const [year, month] = monthInput.split('-').map(Number);
            currentReportData.month = monthInput;

            const monthItems = items.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getFullYear() === year && itemDate.getMonth() + 1 === month;
            });

            const incomeItems = monthItems.filter(i => i.type === 'ingreso');
            const expenseItems = monthItems.filter(i => i.type === 'gasto');
            const paidExpenses = expenseItems.filter(i => i.paid);
            const pendingExpenses = expenseItems.filter(i => !i.paid);

            const totalIncome = incomeItems.reduce((acc, i) => acc + i.amount, 0);
            const totalExpenses = paidExpenses.reduce((acc, i) => acc + i.amount, 0);
            const totalPending = pendingExpenses.reduce((acc, i) => acc + i.amount, 0);
            const balance = totalIncome - totalExpenses;

            document.getElementById('report-income').textContent = `$${formatCurrency(totalIncome)}`;
            document.getElementById('report-expenses').textContent = `$${formatCurrency(totalExpenses)}`;
            document.getElementById('report-pending').textContent = `$${formatCurrency(totalPending)}`;
            document.getElementById('report-balance').textContent = `$${formatCurrency(balance)}`;

            const categoryTotals = {};
            expenseItems.forEach(item => {
                if (!categoryTotals[item.category]) {
                    categoryTotals[item.category] = { total: 0, items: [] };
                }
                categoryTotals[item.category].total += item.amount;
                categoryTotals[item.category].items.push(item);
            });

            currentReportData.categoryData = categoryTotals;

            const sortedCategories = Object.entries(categoryTotals)
                .sort((a, b) => b[1].total - a[1].total);

            drawPieChart(sortedCategories, totalExpenses + totalPending);
            renderCategoryBreakdown(sortedCategories, totalExpenses + totalPending);
        }

        function drawPieChart(categoryData, total) {
            const canvas = document.getElementById('pie-chart');
            const ctx = canvas.getContext('2d');
            const legend = document.getElementById('chart-legend');
            const noExpensesMsg = document.getElementById('no-expenses-msg');

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            legend.innerHTML = '';

            if (categoryData.length === 0 || total === 0) {
                canvas.style.display = 'none';
                legend.style.display = 'none';
                noExpensesMsg.classList.remove('hidden');
                return;
            }

            canvas.style.display = 'block';
            legend.style.display = 'block';
            noExpensesMsg.classList.add('hidden');

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;

            let startAngle = -Math.PI / 2;

            categoryData.forEach(([cat, data], index) => {
                const sliceAngle = (data.total / total) * 2 * Math.PI;
                const color = chartColors[index % chartColors.length];

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();

                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                const percentage = ((data.total / total) * 100).toFixed(1);
                const style = getCategoryStyle(cat);
                
                legend.innerHTML += `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full shrink-0" style="background-color: ${color}"></div>
                        <span class="text-slate-600">${style.label.replace(/^[^\s]+\s/, '')} - ${percentage}%</span>
                    </div>
                `;

                startAngle += sliceAngle;
            });
        }

        function renderCategoryBreakdown(categoryData, total) {
            const container = document.getElementById('category-breakdown');
            const noMsg = document.getElementById('no-categories-msg');

            container.innerHTML = '';

            if (categoryData.length === 0) {
                noMsg.classList.remove('hidden');
                return;
            }

            noMsg.classList.add('hidden');

            categoryData.forEach(([cat, data], index) => {
                const style = getCategoryStyle(cat);
                const percentage = total > 0 ? ((data.total / total) * 100).toFixed(1) : 0;
                const color = chartColors[index % chartColors.length];

                const div = document.createElement('div');
                div.className = 'bg-slate-50 rounded-xl p-3 hover:bg-slate-100 transition cursor-pointer';
                div.onclick = () => showCategoryDetail(cat, data.items);

                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${style.bg} flex items-center justify-center ${style.color}">
                                <i class="fa-solid ${style.icon}"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-700">${style.label}</p>
                                <p class="text-xs text-slate-400">${data.items.length} item${data.items.length > 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-rose-600">$${formatCurrency(data.total)}</p>
                            <p class="text-xs text-slate-400">${percentage}%</p>
                        </div>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all" style="width: ${percentage}%; background-color: ${color}"></div>
                    </div>
                    <p class="text-xs text-indigo-500 mt-2 text-right"><i class="fa-solid fa-eye"></i> Ver detalle</p>
                `;

                container.appendChild(div);
            });
        }

        function showCategoryDetail(category, categoryItems) {
            const style = getCategoryStyle(category);
            document.getElementById('detail-title').innerHTML = `<i class="fa-solid ${style.icon} ${style.color}"></i> ${style.label}`;
            
            const detailList = document.getElementById('detail-list');
            detailList.innerHTML = '';

            categoryItems.sort((a, b) => new Date(a.date) - new Date(b.date));

            categoryItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-lg';
                li.innerHTML = `
                    <div>
                        <p class="font-medium text-slate-700">${item.text}</p>
                        <p class="text-xs text-slate-400">${item.date} ${item.paid ? '<span class="text-emerald-500">â€¢ Pagado</span>' : '<span class="text-amber-500">â€¢ Pendiente</span>'}</p>
                    </div>
                    <p class="font-bold text-rose-600">$${formatCurrency(item.amount)}</p>
                `;
                detailList.appendChild(li);
            });

            document.getElementById('detail-modal').classList.remove('hidden');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // --- PDF Download ---
        async function downloadReportPDF() {
            const monthInput = document.getElementById('report-month').value;
            if (!monthInput) {
                alert('Por favor selecciona un mes primero');
                return;
            }

            const btn = document.getElementById('btn-download-pdf');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generando...';
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 15;
                let yPos = 20;

                const [year, month] = monthInput.split('-').map(Number);
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthName = monthNames[month - 1];

                pdf.setFillColor(99, 102, 241);
                pdf.rect(0, 0, pageWidth, 40, 'F');

                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(22);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Reporte Financiero', pageWidth / 2, 18, { align: 'center' });

                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`${monthName} ${year}`, pageWidth / 2, 30, { align: 'center' });

                yPos = 55;

                const reportIncome = document.getElementById('report-income').textContent;
                const reportExpenses = document.getElementById('report-expenses').textContent;
                const reportPending = document.getElementById('report-pending').textContent;
                const reportBalance = document.getElementById('report-balance').textContent;

                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Resumen del Mes', margin, yPos);
                yPos += 10;

                const summaryData = [
                    { label: 'Ingresos:', value: reportIncome, color: [16, 185, 129] },
                    { label: 'Gastos Pagados:', value: reportExpenses, color: [239, 68, 68] },
                    { label: 'Pendientes:', value: reportPending, color: [245, 158, 11] },
                    { label: 'Balance:', value: reportBalance, color: [99, 102, 241] }
                ];

                pdf.setFontSize(11);
                summaryData.forEach(item => {
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text(item.label, margin, yPos);
                    
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(...item.color);
                    pdf.text(item.value, margin + 45, yPos);
                    yPos += 8;
                });

                yPos += 10;

                const pieCanvas = document.getElementById('pie-chart');
                if (pieCanvas && pieCanvas.style.display !== 'none') {
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Distribucion de Gastos', margin, yPos);
                    yPos += 5;

                    const pieImage = pieCanvas.toDataURL('image/png');
                    pdf.addImage(pieImage, 'PNG', margin, yPos, 60, 60);

                    const legendDiv = document.getElementById('chart-legend');
                    if (legendDiv) {
                        const legendItems = legendDiv.querySelectorAll('div');
                        let legendY = yPos + 5;
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'normal');
                        
                        legendItems.forEach((item, idx) => {
                            if (idx < 10) {
                                const text = item.textContent.trim();
                                pdf.setTextColor(80, 80, 80);
                                pdf.text(text, margin + 70, legendY);
                                legendY += 6;
                            }
                        });
                    }
                    yPos += 70;
                }

                if (Object.keys(currentReportData.categoryData).length > 0) {
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Detalle por Categoria', margin, yPos);
                    yPos += 10;

                    const sortedCats = Object.entries(currentReportData.categoryData)
                        .sort((a, b) => b[1].total - a[1].total);

                    pdf.setFontSize(10);
                    sortedCats.forEach(([cat, data]) => {
                        if (yPos > 270) {
                            pdf.addPage();
                            yPos = 20;
                        }

                        const style = getCategoryStyle(cat);
                        const catName = style.label.replace(/^[^\s]+\s/, '');

                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(60, 60, 60);
                        pdf.text(catName, margin, yPos);

                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(239, 68, 68);
                        pdf.text(`$${formatCurrency(data.total)}`, margin + 60, yPos);

                        pdf.setTextColor(120, 120, 120);
                        pdf.text(`(${data.items.length} items)`, margin + 100, yPos);
                        yPos += 6;

                        data.items.forEach(item => {
                            if (yPos > 270) {
                                pdf.addPage();
                                yPos = 20;
                            }
                            pdf.setTextColor(100, 100, 100);
                            pdf.setFontSize(9);
                            const itemText = `  - ${item.text}: $${formatCurrency(item.amount)} (${item.date})`;
                            pdf.text(itemText, margin + 5, yPos);
                            yPos += 5;
                        });
                        yPos += 4;
                        pdf.setFontSize(10);
                    });
                }

                const pageCount = pdf.internal.getNumberOfPages();
                pdf.setFontSize(8);
                pdf.setTextColor(150, 150, 150);
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.text(`Generado: ${new Date().toLocaleDateString('es-AR')} - Pagina ${i} de ${pageCount}`, 
                             pageWidth / 2, pdf.internal.pageSize.getHeight() - 10, { align: 'center' });
                }

                pdf.save(`reporte_${monthName.toLowerCase()}_${year}.pdf`);

            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('Error al generar el PDF. Intenta nuevamente.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- InicializaciÃ³n ---
        function init() {
            updateCategoryOptions();
            renderList();
            updateTotals();
        }

        form.addEventListener('submit', addItem);
        init();
    </script>
</body>
</html>